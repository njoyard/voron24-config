[gcode_macro PRIMELINE]
gcode:
  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
  {% set travel_speed = vars.travel_speed %}
  {% set z_drop_speed = vars.z_drop_speed %}
  {% set prime_line_length = vars.prime_line_length %}
  {% set prime_line_purge_distance = vars.prime_line_purge_distance %}
  {% set prime_line_flowrate = vars.prime_line_flowrate %}
  {% set prime_line_height = vars.prime_line_height %}
  {% set prime_line_margin = vars.prime_line_margin %}
  {% set prime_line_unretract_length = vars.print_unretract %}
  {% set prime_line_wipe = vars.prime_line_wipe %}
  {% set prime_line_x, prime_line_y = vars.prime_line_start | map('float') %}

  {% set center_x, center_y = [printer.toolhead.axis_maximum.x / 2, printer.toolhead.axis_maximum.y / 2] | map('float') %}

  {% set prime_line_wipe_length = prime_line_length * 0.8 %}
  {% set St = travel_speed * 60 %}
  {% set Sz = z_drop_speed * 60 %}


  {% if printer.exclude_object is defined and printer.exclude_object.objects%}
    {% set points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
    {% set print_x_min = points | map(attribute=0) | min %}
    {% set print_y_min = points | map(attribute=1) | min %}
    {% set print_x_max = points | map(attribute=0) | max %}
    {% set print_y_max = points | map(attribute=1) | max %}
    
    {% set prime_line_x =
        2*center_x - prime_line_x
        if (prime_line_x > center_x and print_x_max < center_x)
        or (prime_line_x < center_x and print_x_min > center_x) 
        else prime_line_x %}
    {% set prime_line_y =
        2*center_y - prime_line_y
        if (prime_line_y > center_y and print_y_max < center_y)
        or (prime_line_y < center_y and print_y_min > center_y) 
        else prime_line_y %}
    {% set prime_line_x = [[prime_line_x, print_x_min - prime_line_margin] | max, print_x_max + prime_line_margin] | min %}
    {% set prime_line_y = [[prime_line_y, print_y_min - prime_line_margin] | max, print_y_max + prime_line_margin] | min %}
  {% endif %}

  {% set prime_line_way = -1 if (prime_line_x > center_x) else 1 %}

  {% set max_extrude_cross_section = printer["configfile"].config["extruder"]["max_extrude_cross_section"]|float %}
  {% set filament_diameter = printer["configfile"].config["extruder"]["filament_diameter"]|float %}
  
  # We first compute the width of the prime line
  {% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
  {% set line_width = purge_volume / (prime_line_height * prime_line_length) %}

  # Then we check that the prime line cross section will not be problematic (exceeding Klipper max_extrude_cross_section)
  # or, if it's the case, we warn the user and add a correction to the length of filament to be purged
  {% if (prime_line_height * line_width) > max_extrude_cross_section %}
    {% if verbose %}
      {action_respond_info("The prime_line_purge_distance of %.4f mm is too high and will exceed the max_extrude_cross_section!" % prime_line_purge_distance)}
    {% endif %}
    {% set prime_line_purge_distance = 0.98 * (max_extrude_cross_section * prime_line_length) / (3.14159 * (filament_diameter / 2)**2) %}
    {% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
    {% set line_width = purge_volume / (prime_line_height * prime_line_length) %}
    {% if verbose %}
      {action_respond_info("Klippain corrected the prime_line_purge_distance to %.4f mm" % prime_line_purge_distance)}
    {% endif %}
  {% endif %}

  # We then compute the height to width ratio and validate that the prime line will not be too thin
  {% if (prime_line_height / line_width) >= 0.5 %} # TODO: validate this 1/2 ratio is good for all
    {action_raise_error("The prime line will be too thin and will probably not stick properly to the bed. Increase its purge distance or decrease its length!")}
  {% endif %}

  # Finally we compute the speed to get the correct flowrate for the prime line
  {% set speed = (prime_line_flowrate / (prime_line_height * line_width)) * 60 |float %}

  G91
  M83
  {% if (printer.toolhead.position.z < 5) %}
    G1 Z5 F{Sz}
  {% endif %}

  # Starting position
  G90
  G0 X{prime_line_x} Y{prime_line_y} F{St}
  G1 Z{prime_line_height} F{Sz|int / 2}

  # Add pressure in the nozzle
  G92 E0
  G1 E{prime_line_unretract_length} F300

  # Prime line
  G92 E0
  G1 X{prime_line_x + prime_line_way*prime_line_length} E{prime_line_purge_distance} F{speed}
  {% if prime_line_wipe %}
    G0 X{prime_line_x + prime_line_way*prime_line_wipe_length} F{St}
  {% endif %}

  # Retract and Z-hop
  G92 E0
  G1 E-0.2 F2100
  G92 E0
  G1 Z3 F{Sz}

  # Additional small movement to get out of the line as some slicers directly emmit
  # a Z- move as a first step that make the toolhead crash back in the line and get dirty
  G91
  G1 X2 Y2 F{St}
  G90
  
  # Flushing Klipper's buffer to ensure the primeline sequence is done before continuing
  M400
