[gcode_macro PAUSE]
rename_existing: _BASE_PAUSE
gcode:
  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
  {% set idle_timeout = vars.pause_idle_timeout %}

  {% if printer.pause_resume.is_paused %}
    ERROR MSG="Printer already paused"
  {% else %}
    SAVE_GCODE_STATE NAME=state_pause
    _BASE_PAUSE
    _PARK_TOOLHEAD POS=park
    SET_IDLE_TIMEOUT TIMEOUT={idle_timeout}
    _SET_LIGHT_STATUS STATUS=paused FROM=pause
    INFO MSG="Print paused."
  {% endif %}

[gcode_macro RESUME]
rename_existing: _BASE_RESUME
gcode:
  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
  {% set speed = vars.travel_speed %}

  {% if not printer.pause_resume.is_paused %}
    ERROR MSG="Printer not paused"
  {% else %}
    INFO MSG="Resuming..."
    RESTORE_GCODE_STATE NAME=state_pause MOVE=1 MOVE_SPEED={speed}
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
    _BASE_RESUME
    _SET_LIGHT_STATUS STATUS=printing FROM=resume
  {% endif %}
