[gcode_macro WIPE_NOZZLE]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set xyfeed = vars.travel_speed * 60 %}
  {% set zfeed = vars.z_drop_speed * 60 %}
  {% set z = vars.wipe_z %}
  {% set z_hop = vars.wipe_z_hop %}
  {% set x_start = vars.wipe_x_start %}
  {% set y_start = vars.wipe_y_start %}
  {% set dx = vars.wipe_dx %}
  {% set dy = vars.wipe_dy %}
  {% set count = vars.wipe_count %}

  SAVE_GCODE_STATE NAME=state_wipe

  INFO MSG="Wiping nozzle..."

  G91 ; relative
  G1 Z{z_hop} F{zfeed} ; Z hop

  G90 ; absolute
  G1 X{x_start} Y{y_start} F{xyfeed} ; Move to XY start
  G1 Z{z} F{zfeed} ; Move to Z start

  {% for i in range(0, count) %}
    G1 X{x_start + dx} Y{y_start + dy} F{xyfeed} ; Move across brush
    G1 X{x_start} Y{y_start} F{xyfeed} ; Move back
  {% endfor %}

  G91 ; relative
  G1 Z{z_hop} F{zfeed} ; Z hop

  RESTORE_GCODE_STATE NAME=state_wipe
