[gcode_macro _FILTER_OFF]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}

  SET_FAN_SPEED FAN={fan} SPEED=0

[gcode_macro _FILTER_SLOW]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}
  {% set speed = vars.filter_speed_slow %}

  SET_FAN_SPEED FAN={fan} SPEED={speed}

[gcode_macro _FILTER_FAST]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}
  {% set speed = vars.filter_speed_fast %}

  SET_FAN_SPEED FAN={fan} SPEED={speed}

[gcode_macro SET_HEATER_TEMPERATURE]
rename_existing: _SET_HEATER_TEMPERATURE
gcode:
	{% set heater = params.HEATER | default("None") %}
	{% set target = params.TARGET | default(0) | int %}

  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set threshold = vars.filter_threshold %}
	
	{% if heater | lower == "extruder" %}
		M104 S{target}
	{% elif heater | lower == "heater_bed" %}
		_BASE_M140 S{target}

		{% if target >= threshold %}
      INFO MSG="Setting filter fans to slow speed"
			_FILTER_SLOW
			UPDATE_DELAYED_GCODE ID=_FILTER_LOOP DURATION=1
		{% else %}
      INFO MSG="Turning filter fans off"
			_FILTER_OFF
			UPDATE_DELAYED_GCODE ID=_FILTER_LOOP DURATION=0
		{% endif %}
	{% else %}
		{action_respond_info("Heater %s not supported" % heater)}
	{% endif %}

	{% if heater |lower == "heater_bed" %}
	{% endif %}


[gcode_macro _FILTER_CHECK]
variable_current_mode: 'off'
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set threshold = vars.filter_threshold %}

  {% set target = printer.heater_bed.target %}
  {% set temp = printer.heater_bed.temperature %}

  {% if target >= threshold %}
    {% if temp >= target - 1 %}
      {% if current_mode != 'fast' %}
        INFO MSG="Bed hot, setting filter to fast speed"
        _FILTER_FAST
      {% endif %}
    {% else %}
      {% if current_mode != 'slow' %}
        INFO MSG="Bed heating, setting filter to slow speed"
        _FILTER_SLOW
      {% endif %}
    {% endif %}
  {% endif %}
  
[gcode_macro _FILTER_COOLDOWN]
variable_cooldown_remaining: 0
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set cooldown = vars.filter_cooldown_time %}
  {% set threshold = vars.filter_threshold %}

  {% if printer.heater_bed.temperature >= threshold %}
    INFO MSG="Starting filter cooldown"
    SET_GCODE_VARIABLE MACRO=_FILTER_COOLDOWN VARIABLE=cooldown_remaining VALUE={cooldown}
    UPDATE_DELAYED_GCODE ID=FILTER_COOLDOWN DURATION=1
  {% endif %}

[delayed_gcode FILTER_COOLDOWN]
gcode:
  {% set remaining = printer['gcode_macro _FILTER_COOLDOWN'].cooldown_remaining %}
  {% if remaining > 0 %}
    SET_GCODE_VARIABLE MACRO=_FILTER_COOLDOWN VARIABLE=cooldown_remaining VALUE={remaining - 1}
    UPDATE_DELAYED_GCODE ID=FILTER_COOLDOWN DURATION=1
  {% else %}
    INFO MSG="Filter cooldown finished, turning filter off"
  {% endif %}
