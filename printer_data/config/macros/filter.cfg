[gcode_macro _FILTER_OFF]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}

  {% set cur = printer['gcode_macro _FILTER_CHECK'].current_state %}
  
  {% if cur != 'off' %}
    INFO MSG="Setting filter to fast speed"
    SET_GCODE_VARIABLE MACRO=_FILTER_CHECK VARIABLE=current_state VALUE="'fast'"
  {% endif %}

  SET_FAN_SPEED FAN={fan} SPEED={speed}

[gcode_macro _FILTER_SLOW]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}
  {% set speed = vars.filter_speed_slow %}

  {% set cur = printer['gcode_macro _FILTER_CHECK'].current_state %}
  
  {% if cur != 'slow' %}
    INFO MSG="Setting filter to slow speed"
    SET_GCODE_VARIABLE MACRO=_FILTER_CHECK VARIABLE=current_state VALUE="'slow'"
  {% endif %}

  SET_FAN_SPEED FAN={fan} SPEED={speed}

[gcode_macro _FILTER_FAST]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}
  {% set speed = vars.filter_speed_fast %}

  {% set cur = printer['gcode_macro _FILTER_CHECK'].current_state %}
  
  {% if cur != 'fast' %}
    INFO MSG="Setting filter to fast speed"
    SET_GCODE_VARIABLE MACRO=_FILTER_CHECK VARIABLE=current_state VALUE="'fast'"
  {% endif %}

  SET_FAN_SPEED FAN={fan} SPEED={speed}

[gcode_macro _FILTER_CHECK]
variable_current_state: 'off'
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set threshold = vars.filter_threshold %}

  {% if printer.heater_bed.target > threshold %}
    {% if printer.heater_bed.temperature >= printer.heater_bed.target - 1 %}
      _FILTER_FAST
    {% else %}
      _FILTER_SLOW
    {% endif %}
  {% endif %}