[gcode_macro _FILTER_OFF]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}

  SET_FAN_SPEED FAN={fan} SPEED=0

[gcode_macro _FILTER_SLOW]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}
  {% set speed = vars.filter_speed_slow %}

  SET_FAN_SPEED FAN={fan} SPEED={speed}

[gcode_macro _FILTER_FAST]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}
  {% set speed = vars.filter_speed_fast %}

  SET_FAN_SPEED FAN={fan} SPEED={speed}

[gcode_macro SET_HEATER_TEMPERATURE]
rename_existing: _BASE_SET_HEATER_TEMPERATURE
gcode:
	{% set heater = params.HEATER | default("None") %}
	{% set target = params.TARGET | default(0) | int %}

  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set threshold = vars.filter_threshold %}
	
	{% if heater | lower == "extruder" %}
		M104 S{target}
	{% elif heater | lower == "heater_bed" %}
		_BASE_M140 S{target}

		{% if target >= threshold %}
      INFO MSG="Heating bed to {target}: setting filter fans to slow speed"
			_FILTER_SLOW
			UPDATE_DELAYED_GCODE ID=_FILTER_LOOP DURATION=1
		{% else %}
      INFO MSG="Heating bed to {target}: turning filter fans off"
			_FILTER_OFF
			UPDATE_DELAYED_GCODE ID=_FILTER_LOOP DURATION=0
		{% endif %}
	{% else %}
		{action_respond_info("Heater %s not supported" % heater)}
	{% endif %}
  
[gcode_macro M190]
rename_existing: _BASE_M190
gcode:
  {% set target = params.S | default(0) | int %}

  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set threshold = vars.filter_threshold %}
  
  {% if target >= threshold %}
    INFO MSG="Waiting for bed to reach {target}: setting filter fans to slow speed"
    _FILTER_SLOW
  {% else %}
    INFO MSG="Waiting for bed to reach {target}: turning filter fans off"
    _FILTER_OFF
  {% endif %}
	
	M140 {rawparams}

  {% if target != 0 %}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={target | int} MAXIMUM={target | int + 5}
  {% endif %}
	  
  {% if target >= threshold %}
    INFO MSG="Bed reached {target}: turning filter fans to fast speed"
    _FILTER_FAST
  {% endif %}
  