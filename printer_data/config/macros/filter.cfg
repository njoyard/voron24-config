[gcode_macro _FILTER_OFF]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}

  SET_FAN_SPEED FAN={fan} SPEED=0

[gcode_macro _FILTER_SLOW]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}
  {% set speed = vars.filter_speed_slow %}

  SET_FAN_SPEED FAN={fan} SPEED={speed}

[gcode_macro _FILTER_FAST]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}
  {% set speed = vars.filter_speed_fast %}

  SET_FAN_SPEED FAN={fan} SPEED={speed}

[gcode_macro _FILTER_STATUS]
variable_cooldown_remaining: 0
variable_current_mode: 'off'
gcode:

[delayed_gcode FILTER_MONITOR]
initial_duration: 1
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set thrs = vars.filter_threshold %}
  {% set interval = vars.filter_monitor_interval %}
  {% set cooldown = vars.filter_cooldown_time %}

  {% set status = printer['gcode_macro _FILTER_STATUS'] %}
      {% set remain = status.cooldown_remaining %}


  {% if printer.heater_bed.target >= thrs %}
    {% if printer.heater_bed.temperature >= printer.heater_bed.target - 5 %}
      _FILTER_FAST
    {% else %}
      _FILTER_SLOW
    {% endif %}

    {% if printer.heater_bed.temperature >= thrs %}
      SET_GCODE_VARIABLE MACRO=_FILTER_STATUS VARIABLE=cooldown_remaining VALUE={cooldown}
    {% %}
  {% else %}
    {% if remain > 0 %}
      SET_GCODE_VARIABLE MACRO=_FILTER_STATUS VARIABLE=cooldown_remaining VALUE={cooldown - interval}
    {% else %}
      _FILTER_OFF
    {% endif %}
  {% endif %}

  UPDATE_DELAYED_GCODE ID=FILTER_MONITOR DURATION={interval}