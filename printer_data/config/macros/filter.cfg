[gcode_macro _FILTER_OFF]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}

  SET_FAN_SPEED FAN={fan} SPEED=0

[gcode_macro _FILTER_SLOW]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}
  {% set speed = vars.filter_speed_slow %}

  SET_FAN_SPEED FAN={fan} SPEED={speed}

[gcode_macro _FILTER_FAST]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}
  {% set speed = vars.filter_speed_fast %}

  SET_FAN_SPEED FAN={fan} SPEED={speed}

[gcode_macro _FILTER_CHECK]
variable_current_state: 'off'
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set threshold = vars.filter_threshold %}

  {% if printer.heater_bed.target > threshold %}
    {% if printer.heater_bed.temperature >= printer.heater_bed.target - 1 %}
      _FILTER_FAST
    {% else %}
      _FILTER_SLOW
    {% endif %}
  {% endif %}