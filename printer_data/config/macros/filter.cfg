[gcode_macro _FILTER_OFF]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}

  SET_GCODE_VARIABLE MACRO=_FILTER_STATUS VARIABLE=current_mode VALUE="'off'"
  SET_FAN_SPEED FAN={fan} SPEED=0

[gcode_macro _FILTER_SLOW]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}
  {% set speed = vars.filter_speed_slow %}

  SET_GCODE_VARIABLE MACRO=_FILTER_STATUS VARIABLE=current_mode VALUE="'slow'"
  SET_FAN_SPEED FAN={fan} SPEED={speed}

[gcode_macro _FILTER_FAST]
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set fan = vars.filter_fan %}
  {% set speed = vars.filter_speed_fast %}

  SET_GCODE_VARIABLE MACRO=_FILTER_STATUS VARIABLE=current_mode VALUE="'fast'"
  SET_FAN_SPEED FAN={fan} SPEED={speed}

[gcode_macro _FILTER_STATUS]
variable_cooldown_remaining: 0
variable_current_mode: 'off'
gcode:

[delayed_gcode FILTER_MONITOR]
initial_duration: 1
gcode:
  {% set vars = printer['gcode_macro _USER_VARIABLES'] %}
  {% set thrs = vars.filter_threshold %}
  {% set interval = vars.filter_monitor_interval %}
  {% set cooldown = vars.filter_cooldown_time %}

  {% set status = printer['gcode_macro _FILTER_STATUS'] %}
  {% set remain = status.cooldown_remaining %}
  {% set current = status.current_mode %}

  {% if printer.heater_bed.target >= thrs %}
    {% if printer.heater_bed.temperature >= printer.heater_bed.target - 5 %}
      {% if current_mode != 'fast' %}
        INFO MSG="Switching filter to fast speed"
        _FILTER_FAST
      {% endif %}
    {% else %}
      {% if current_mode != 'slow' %}
        INFO MSG="Switching filter to slow speed"
        _FILTER_SLOW
      {% endif %}
    {% endif %}

    {% if printer.heater_bed.temperature >= thrs %}
      SET_GCODE_VARIABLE MACRO=_FILTER_STATUS VARIABLE=cooldown_remaining VALUE={cooldown}
    {% %}
  {% else %}
    {% if remain > 0 %}
      SET_GCODE_VARIABLE MACRO=_FILTER_STATUS VARIABLE=cooldown_remaining VALUE={cooldown - interval}
    {% else %}
      {% if current_mode != 'off' %}
        INFO MSG="Switching filter off"
        _FILTER_OFF
      {% endif %}
    {% endif %}
  {% endif %}

  UPDATE_DELAYED_GCODE ID=FILTER_MONITOR DURATION={interval}
