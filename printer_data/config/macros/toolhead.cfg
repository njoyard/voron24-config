[gcode_macro _PARK_TOOLHEAD]
description: Move toolhead to a parking position in parking_positions
gcode:
  {% set pos_id = params.POS | default("park") %}

  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
  {% set positions = vars.parking_positions %}
  {% set feed = vars.travel_speed * 60 %}

  {% if pos_id in positions %}
    {% set pos = positions[pos_id] %}
    {% set cur = printer.toolhead.position %}
    {% set maxes = printer.toolhead.axis_maximum.z %}
    {% set move = {} %}
    
    {% if 'x' in pos %}
      {% set _ = move.update({'X': pos.x}) %}
    {% elif 'xr' in pos %}
      {% set _ = move.update({'X': [(cur.x | float) + pos.xr, maxes.x | float] | min}) %}
    {% endif %}

    {% if 'y' in pos %}
      {% set _ = move.update({'Y': pos.y}) %}
    {% elif 'yr' in pos %}
      {% set _ = move.update({'Y': [(cur.y | float) + pos.yr, maxes.y | float] | min}) %}
    {% endif %}

    {% if 'y' in pos %}
      {% set _ = move.update({'Z': pos.z}) %}
    {% elif 'zr' in pos %}
      {% set _ = move.update({'Z': [(cur.z | float) + pos.zr, maxes.z | float] | min}) %}
    {% endif %}

    {% if 'X' in move or 'Y' in move or 'Z' in move %}
      G90 ; absolute
      G1 {% for p in move %}{'%s%s ' % (p, move[p])}{% endfor %} F{feed}
    {% endif %}
  {% else %}
    RESPOND TYPE=error MSG="Unknown park position: {pos_id}"
  {% endif %}

[gcode_macro SERVICE_TOOLHEAD]
description: Move toolhead to the service position
gcode:
  _PARK_TOOLHEAD POS=service
