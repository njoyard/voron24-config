
[gcode_macro SET_STATUS_LIGHTS]
description: Set status lights
gcode:
  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}

  {% set status = params.STATUS | default('off') %}

[gcode_macro LIGHT_ON]
description: Full case lights
gcode:
  _SET_CASE_LIGHTS MODE=on

[gcode_macro LIGHT_OFF]
description: Turn off case lights
gcode:
  _SET_CASE_LIGHT MODE=off

[gcode_macro LIGHT_DIM]
description: Dim case lights
gcode:
  _SET_CASE_LIGHT MODE=dim

[gcode_macro _SET_CASE_LIGHT]
gcode:
  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
  
  {% set modes = vars.lights_modes %}
  {% set mode = params.MODE | default('on') %}
  {% if mode in modes %}
    SET_LED LED=daylight WHITE={modes[mode]} SYNC=0 TRANSMIT=1
  {% endif %}

[gcode_macro _SET_LED_STATUS]
gcode:
  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
  
  {% set defs = vars.leds_definitions %}
  {% set statuses = vars.leds_statuses %}

  {% set status = params.STATUS | default('off') %}
  {% set target = params.TARGET | default('all') %}

  {% if status in statuses %}
    {% if target == 'all' %}
      {% set targets = statuses[status].keys() | list %}
    {% else %}
      {% set targets = [target] %}
    {% endif %}

    {% for target in targets %}
      {% if target in statuses[status] and target in defs %}
        {% set def = defs[target] %}
        {% set colors = statuses[status][target] %}
        {% set sl_params = {'LED': def.config, 'SYNC': 0, 'RED': colors.r|default(0), 'GREEN': colors.g|default(0), 'BLUE': colors.b|default(0), 'WHITE': colors.w|default(0) } %}
        
        {% if 'index' in def %}
          {% for idx in def.index %}
            SET_LED {% for p in sl_params %}{'%s=%s' % (p, sl_params[p])} {% endfor %} INDEX={idx} TRANSMIT={1 if loop.last else 0}
          {% endfor %}
        {% else %}
          SET_LED {% for p in sl_params %}{'%s=%s' % (p, sl_params[p])} {% endfor %} TRANSMIT=1
        {% endif %}
      {% else %}
        RESPOND TYPE=error MESSAGE="No such target: {target}"
      {% endif %}
    {% endfor %}
  {% else %}
        RESPOND TYPE=error MESSAGE="No such status: {status}"
  {% endif %}