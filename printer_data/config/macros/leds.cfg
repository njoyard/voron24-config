[gcode_macro _SET_LIGHT_COLOR]
description: Sets a light in lights_definition to a color in lights_colors
gcode:
  {% set light_id = params.LIGHT %}
  {% set color_id = params.COLOR %}

  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
  {% set lights = vars.lights_definitions %}
  {% set colors = vars.lights_colors %}

  {% if light_id in lights %}
    {% set light = lights[light_id] %}

    {% if color_id in colors %}
      {% set color = colors[color_id] %}
      {% set sl_params = {
          'LED': light.config,
          'SYNC': 0,
          'RED': colors.r | default(0),
          'GREEN': colors.g | default(0),
          'BLUE': colors.b | default(0),
          'WHITE': colors.w | default(0)
      } %}
      
      {% if 'index' in light %}
        {% for idx in light.index %}
          SET_LED {% for p in sl_params %}{'%s=%s' % (p, sl_params[p])} {% endfor %} INDEX={idx} TRANSMIT={1 if loop.last else 0}
        {% endfor %}
      {% else %}
        SET_LED {% for p in sl_params %}{'%s=%s' % (p, sl_params[p])} {% endfor %} TRANSMIT=1
      {% endif %}
    {% else %}
      RESPOND TYPE=error MSG="Unknown color: {color_id}"
    {% endif %}
  {% else %}
    RESPOND TYPE=error MSG="Unknown light: {light_id}"
  {% endif %}

[gcode_macro _SET_LIGHT_STATUS]
description: Activate a light status in lights_statuses
gcode:
  {% set status_id = params.STATUS %}

  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
  {% set statuses = vars.lights_statuses %}

  {% if status_id in statuses %}
    {% for light_id, color_id in statuses[status_id].items() %}
    RESPOND MSG="Set {light_id} to {color_id}"
      _SET_LIGHT_COLOR LIGHT={light_id} COLOR={color_id}
    {% endfor %}
  {% else %}
    RESPOND TYPE=error MSG="Unknown status: {status_id}"
  {% endif %}
