[gcode_macro _SET_LIGHT_COLOR]
description: Sets a light in <lights_definition> to a color in <lights_colors>
gcode:
  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}

  {% set lights = vars.lights_definitions %}
  {% set colors = vars.lights_colors %}

  {% set light_id = params.LIGHT %}
  {% set color_id = params.COLOR %}

  {% if light_id in lights %}
    {% set light = lights[light_id] %}

    {% if color_id in colors %}
      {% set color = colors[color_id] %}
      {% set sl_params = {
          'LED': light.config,
          'SYNC': 0,
          'RED': colors.r|default(0),
          'GREEN': colors.g|default(0),
          'BLUE': colors.b|default(0),
          'WHITE': colors.w|default(0)
      } %}
      
      {% if 'index' in light %}
          {% for idx in def.index %}
            SET_LED {% for p in sl_params %}{'%s=%s' % (p, sl_params[p])} {% endfor %} INDEX={idx} TRANSMIT={1 if loop.last else 0}
          {% endfor %}
      {% else %}
      {% endif %}
    {% else %}
      RESPOND TYPE=error MSG="Unknown color: {color_id}"
    {% endif %}
  {% else %}
    RESPOND TYPE=error MSG="Unknown light: {light_id}"
  {% endif %}



[gcode_macro _SET_LED_STATUS]
gcode:
  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
  
  {% set defs = vars.leds_definitions %}
  {% set statuses = vars.leds_statuses %}

  {% set status = params.STATUS | default('off') %}
  {% set target = params.TARGET | default('all') %}

  {% if status in statuses %}
    {% if target == 'all' %}
      {% set targets = statuses[status].keys() | list %}
    {% else %}
      {% set targets = [target] %}
    {% endif %}

    {% for target in targets %}
      {% if target in statuses[status] and target in defs %}
        {% set def = defs[target] %}
        {% set colors = statuses[status][target] %}
        {% set sl_params = {'LED': def.config, 'SYNC': 0, 'RED': colors.r|default(0), 'GREEN': colors.g|default(0), 'BLUE': colors.b|default(0), 'WHITE': colors.w|default(0) } %}
        
        {% if 'index' in def %}
          {% for idx in def.index %}
            SET_LED {% for p in sl_params %}{'%s=%s' % (p, sl_params[p])} {% endfor %} INDEX={idx} TRANSMIT={1 if loop.last else 0}
          {% endfor %}
        {% else %}
          SET_LED {% for p in sl_params %}{'%s=%s' % (p, sl_params[p])} {% endfor %} TRANSMIT=1
        {% endif %}
      {% else %}
        RESPOND TYPE=error MSG="Unknown target: {target}"
      {% endif %}
    {% endfor %}
  {% else %}
        RESPOND TYPE=error MSG="Unknown status: {status}"
  {% endif %}