[delayed_gcode TRACK_PRINT_TIME]
initial_duration: 60
gcode:
  {% set printing = printer.print_stats.state == 'printing' %}
  {% set curtime = printer.save_variables.variables.total_print_minutes | default(0) %}

  {% if printing %}
    SAVE_VARIABLE VARIABLE=total_print_minutes VALUE={curtime + 1}
  {% else %}
    _TRACK_CHECK_COUNTERS
  {% endif %}

  UPDATE_DELAYED_GCODE ID=TRACK_PRINT_TIME DURATION=60

[gcode_macro _TRACK_CHECK_COUNTERS]
gcode:
  {% set svv = printer.save_variables.variables %}
  {% set curtime = svv.total_print_minutes | default(0) %}

  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
  {% set counters = vars.counters %}

  {% for counter_id in counters %}
    {% set counter = counters[counter_id] %}
    {% set interval = counter.hours * 60 %}
    {% set action = counter.action %}

    {% if svv['last_action_%s' % counter_id] is defined %}
      {% set last_action = svv['last_action_%s' % counter_id] %}
      {% set elapsed = curtime - last_action %}

      {% if elapsed > interval %}
        {% set last_warned = svv['last_warned_%s' % counter_id] | default(0) %}
        {% if last_warned + 60 < curtime %}
          INFO NOTIFY=1 MSG="Action needed: {action} (last time was {(elapsed / 60) | float} print hours ago), confirm with TRACK_ACTION ID={counter_id}"
          SAVE_VARIABLE VARIABLE=last_warned_{counter_id} VALUE={curtime}
        {% endif %}
      {% endif %}
    {% else %}
      SAVE_VARIABLE VARIABLE=last_action_{counter_id} VALUE={curtime}
    {% endif %}
  {% endfor %}

[gcode_macro TRACK_ACTION]
gcode:
  {% set svv = printer.save_variables.variables %}
  {% set curtime = svv.total_print_minutes %}

  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
  {% set counters = vars.counters %}

  {% if params.ID in counters %}
    SAVE_VARIABLE VARIABLE=last_action_{params.ID} VALUE={curtime}
    INFO MSG="Action tracked: {params.ID}"
  {% else %}
    ERROR MSG="No such action: {params.ID}"
  {% endif %}

[gcode_macro _TRACK_DISPLAY_TIME]
gcode:
  {% set fmt = params.FORMAT | default('%s') %}
  {% set value = params.MINUTES | float %}
  {% set relative = params.RELATIVE | default(0) | int %}

  {% set negative = value < 0 %}
  {% if negative %}
    {% set value = -value %}
  {% endif %}

  {% set hours = value / 60 | int %}
  {% set minutes = value % 60 %}

  {% set timestr = '%dh %02dm' % (value / 60 | int, value % 60)%}
  {% if relative %}
    {% set timestr = ('%s ago' if negative else 'in %s') % timestr %}
  {% endif %}

  INFO MSG="{fmt % timestr}"

[gcode_macro TRACK_STATUS]
gcode:
  {% set svv = printer.save_variables.variables %}
  {% set curtime = svv.total_print_minutes %}

  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
  {% set counters = vars.counters %}

  _TRACK_DISPLAY_TIME FORMAT="Total print time: %s" MINUTES={curtime}
  {% for counter_id in counters %}
    {% set counter = counters[counter_id] %}
    {% set action = counter.action %}
    {% set interval = counter.hours * 60 %}
    {% set last_done = svv['last_action_%s' % counter_id] | default(0) %}
    {% set remaining = (last_done + interval) - curtime %}

    _TRACK_DISPLAY_TIME FORMAT="- {action} due %s" MINUTES={remaining} RELATIVE=1
  {% endfor %}

[gcode_macro SET_PRINT_STATS_INFO]
rename_existing: _BASE_SET_PRINT_STATS_INFO
gcode:
  {% set layer = params.CURRENT_LAYER | default(0) | int %}

  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
  {% set start_layers = vars.lights_print_start_layers %}

  {% set last_status = printer["gcode_macro _SET_LIGHT_STATUS"].last_status %}

  {% if layer > start_layers and last_status != 'printing' %}
    _SET_LIGHT_STATUS STATUS=printing
  {% endif %}
  
  _BASE_SET_PRINT_STATS_INFO {rawparams}
