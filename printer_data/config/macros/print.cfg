
[gcode_macro START_PRINT]
gcode:
  G32                            ; home all axes
  G1 Z20 F3000                   ; move nozzle away from bed
   
[gcode_macro END_PRINT]
gcode:
  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
  {% set retract = vars.print_retract %}

  SAVE_GCODE_STATE NAME=state_end
  M400 ; wait for completion

  {% if printer.extruder.can_extrude %}
    VERBOSE MSG="Retracting..."
    G92 E0 ; reset extruder
    G1 E-{retract} F3600
  {% endif %}

  VERBOSE MSG="Wiping and lifting..."
  _PARK_TOOLHEAD POS=wipe
  _PARK_TOOLHEAD POS=lift
  M400 ; wait for completion

  VERBOSE MSG="Turning off heaters and fans..."
  TURN_OFF_HEATERS
  M107 ; fan off

  VERBOSE MSG="Parking..."
  _PARK_TOOLHEAD POS=park
  M400 ; wait for completion

  BED_MESH_CLEAR
  M84 ; turn off motors

  _SET_LIGHT_STATUS STATUS=finished
  RESPOND MSG="Print finished."

  RESTORE_GCODE_STATE NAME=state_end MOVE=0

[gcode_macro CANCEL_PRINT]
gcode:
  {% set vars = printer["gcode_macro _USER_VARIABLES"] %}
  {% set retract = vars.print_retract %}

  SAVE_GCODE_STATE NAME=state_cancel
  M400 ; wait for completion

  {% if printer.extruder.can_extrude %}
    VERBOSE MSG="Retracting..."
    G92 E0 ; reset extruder
    G1 E-{retract} F3600
  {% endif %}

  VERBOSE MSG="Wiping and lifting..."
  _PARK_TOOLHEAD POS=wipe
  _PARK_TOOLHEAD POS=lift
  M400 ; wait for completion

  VERBOSE MSG="Turning off heaters and fans..."
  TURN_OFF_HEATERS
  M107 ; fan off

  VERBOSE MSG="Parking..."
  _PARK_TOOLHEAD POS=park
  M400 ; wait for completion

  CLEAR_PAUSE
  BED_MESH_CLEAR
  SDCARD_RESET_FILE
  M84 ; turn off motors

  _SET_LIGHT_STATUS STATUS=finished
  RESPOND MSG="Print canceled."

  RESTORE_GCODE_STATE NAME=state_cancel MOVE=0
